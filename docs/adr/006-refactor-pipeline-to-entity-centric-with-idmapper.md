# ADR-006: 将数据流水线重构为以 IDMapper 为中心的实体元数据驱动模型

**状态：** 已接受 (Accepted)

**日期：** 2025-11-05

---

## 背景 (Context)

在完成了 **ADR-005（中心化实体校验）** 的设计后，我们在实施过程中发现了一个更根本的架构问题：**实体元信息（特别是其来源数据集）的丢失与数据流的断裂**。

我们当时的流水线设计如下：

1.  所有`Processor`的输出被合并。
2.  从合并后的 DataFrame 中提取一个“无来源”的实体清单。
3.  对这个清单进行丰富化和校验。
4.  在流水线的**末端**，才用原始的`processor_outputs`来初始化`IDMapper`以追踪来源。

这个流程导致了一个核心矛盾：我们拥有一个纯净的实体集（`valid_entities_df`），和一个富含来源信息的`IDMapper`，但这两者之间**没有一个清晰的、可靠的连接**。我们无法为一个“纯净实体”查询它的“出身”。这使得实现更高级的、依赖于实体来源的下游逻辑（如“主角/配角”感知的负采样）变得极其困难和“hacky”。

问题的根源在于，`IDMapper`被当作一个流程末端的、被动的工具，而不是流程中核心的、主动的状态管理器。

## 决策 (Decision)

我们将对数据处理流水线进行一次根本性的架构重构，从“流程驱动”演进为“**实体元数据中心驱动**”。**`IDMapper`** 将不再是流程末端的一个工具，而是成为贯穿始终的、**负责管理所有实体元信息（ID, types, sources）的中央上下文服务**。

**新的流水线工作流如下：**

1.  **立即初始化`IDMapper` (Capture Metadata First)**:

    - 在`main_pipeline`的**最开始**，一旦`load_datasets`返回`processor_outputs`字典，就**立即**用它来实例化`IDMapper`。
    - 在这一刻，`IDMapper`已经完成了对所有原始实体（无论有效与否）的元信息（所有类型、所有来源数据集）的**全面聚合**。

2.  **`IDMapper`产出实体清单**:

    - 为`IDMapper`新增一个`build_entity_manifest()`方法。
    - 该方法将`IDMapper`内部聚合的、富含元信息的实体数据库，转换为一个标准的 DataFrame（“实体清单”）。这个清单**天生就携带**了每个实体的`all_sources`等元信息。

3.  **以清单为中心进行处理**:

    - 后续的`_stage3_enrich`（丰富化）和`_stage4_validate`（校验）等步骤，都将直接在这个由`IDMapper`产出的、富含信息的实体清单上进行操作。

4.  **最终化`IDMapper`状态**:

    - 在实体校验完成并产出`valid_entities_df`后，为`IDMapper`新增一个`finalize_with_valid_entities(valid_entity_ids)`方法。
    - 该方法会用这个纯净的实体 ID 集合来“更新”`IDMapper`的内部状态，丢弃所有无效实体的元信息，并只为有效实体分配最终的逻辑 ID。

5.  **下游服务消费**:
    - 所有下游服务（`Sampler`, `Splitter`, `Trainer`等）现在都可以从这个最终的、纯净且富含元信息的`IDMapper`中，通过新的查询 API（如`get_ids_by_filter`），获取它们做出智能化决策所需的一切信息。

## 备选方案 (Considered Options)

**1. "打补丁"式信息传递**

- **方案描述：** 不改变`IDMapper`的调用时机。在`_stage2_build_entity_manifest`时，手动为实体清单 DataFrame 添加一列`sources`。然后在`_stage4_validate`之后，再将`valid_entities_df`中的`sources`信息以某种方式“注入”到`IDMapper`中。
- **优点：** 对`main_pipeline`的流程改动较小。
- **缺点：**
  - **逻辑极其混乱：** `sources`信息的管理权责不清晰，在多个模块之间传来传去，容易出错。
  - **“双重真理”：** `sources`信息同时存在于 DataFrame 和（后期的）`IDMapper`中，违反了单一事实来源原则。
- **决策理由：** 这是一种“头痛医头、脚痛医脚”的方案，会使架构变得复杂和不可靠，予以否决。

## 后果 (Consequences)

### 正面影响

- **信息流的逻辑一致性：** 从根本上解决了实体元信息（特别是来源）在流水线中途丢失的问题。信息流现在是清晰、连续且无损的。
- **`IDMapper`职责升维：** `IDMapper`不再是一个简单的 ID 转换器，而是成为了名副其实的“**实体元数据中心**”，是实体信息的唯一事实来源（Single Source of Truth）。
- **解锁下游智能化能力：**
  - **“角色感知”的负采样**：`SupervisionFileManager`现在可以轻易地向`IDMapper`查询“主角”实体池来进行负采样。
  - **精细化的采样/划分**：`Sampler`和`Splitter`可以基于实体的`sources`或`types`元信息，实现更复杂的、由配置驱动的策略。
  - **高级的分析能力**：分析脚本可以轻松地对不同来源的实体进行分组统计和比较。
- **架构的纯粹性与解耦：** `main_pipeline`的职责更加纯粹（只负责编排），而实体管理的复杂性被完美地封装在了`IDMapper`内部。

### 负面影响/权衡

- **一次性的重构成本：** 需要对`main_pipeline`的执行流程和`IDMapper`的接口进行一次中等规模的重构。
- **`IDMapper`的职责加重：** `IDMapper`现在承担了更核心、更重的职责。然而，我们认为这是合理的，因为它使其“实体身份管理者”的定位更加名副其实。

---

## 关联的 ADR

- **取代（Supersedes）**: 本 ADR 提出的新架构，继承并完善了`ADR-003`和`ADR-005`中的思想，使它们成为这个更大框架下的实现细节。因此，本 ADR 取代了`ADR-003`和`ADR-005`作为顶层的数据模型设计决策。
